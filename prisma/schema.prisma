generator client {
  provider      = "prisma-client"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

enum YearOfStudy {
  FIRST_YEAR
  SECOND_YEAR
  THIRD_YEAR
  FOURTH_YEAR
}

enum Branch {
  CSE
  CSBS
  CSD
  CSIT
  IT
  AI_DS
  AI_ML
  ECE
  EEE
  MECH
  CIVIL
  CHEM
  BIO
  OTHER
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum PaymentStatus {
  PENDING
  VERIFIED
  REJECTED
}

model User {
  id               String @id @default(cuid())
  registrationCode String @unique // IC2K26-XXXXXX

  // Personal Info
  fullName           String
  registrationNumber String @unique // 10-digit college ID
  email              String @unique
  phone              String @unique

  // Academic Info
  collegeName           String      @default("SRKR Engineering College")
  yearOfStudy           YearOfStudy
  branch                Branch
  gender                Gender
  isCodingClubAffiliate Boolean     @default(false)
  affiliateId           String?

  // CP Handles (optional)
  codechefHandle   String?
  leetcodeHandle   String?
  codeforcesHandle String?

  // Payment
  transactionId String        @unique
  screenshotUrl String // Cloudinary URL
  paymentStatus PaymentStatus @default(PENDING)

  // Attendance
  attended     Boolean   @default(false)
  attendedAt   DateTime?
  attendedBy   String?
  checkInCount Int       @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Full-text search vector (populated via trigger)
  searchVector Unsupported("tsvector")?

  attendanceLogs AttendanceLog[]
  audits         Audit[]

  @@index([email])
  @@index([registrationNumber])
  @@index([transactionId])
  @@index([paymentStatus])
  @@index([attended])
  @@index([branch])
  @@index([yearOfStudy])
  @@index([createdAt])
  @@index([branch, yearOfStudy, paymentStatus])
}

model Admin {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  attendanceLogs AttendanceLog[]

  @@index([email])
}

model AttendanceLog {
  id             String   @id @default(cuid())
  registrationId String
  adminId        String
  scannedAt      DateTime @default(now())
  ipAddress      String?
  deviceInfo     String?

  user  User  @relation(fields: [registrationId], references: [id])
  admin Admin @relation(fields: [adminId], references: [id])

  @@index([registrationId])
  @@index([adminId])
  @@index([scannedAt])
}

enum AuditEvent {
  REGISTRATION_STARTED
  REGISTRATION_SUCCESS
  REGISTRATION_FAILED
  EMAIL_QUEUED
  EMAIL_SENT
  EMAIL_FAILED
}

model Audit {
  id        String     @id @default(cuid())
  event     AuditEvent
  payload   Json
  userId    String?
  createdAt DateTime   @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([event])
  @@index([userId])
  @@index([createdAt])
}
